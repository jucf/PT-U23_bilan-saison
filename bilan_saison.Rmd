---
title: "Bilan saison 2021"
output:
  pdf_document: 
    latex_engine: xelatex
dev: cairo_pdf
mainfont: Arial
fig_caption: yes
fontsize: 12pt
classoption: svgnames
df_print: paged
toc: false
header-includes:
- \pagenumbering{gobble} 
- \usepackage{graphicx}
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \setlength\headheight{1.4cm}
- \fancyhead[R]{\includegraphics[height=1.6cm]{logo-ltips.png}}
- \renewcommand{\headrulewidth}{0pt} 
- \fancyfoot[C]{\thepage} 
- \usepackage{fancyhdr}
- \usepackage{float}
# bug trop de figure
- \usepackage[maxfloats=256]{morefloats}
- \maxdeadcycles=1000
- \usepackage{caption}
# captions gras
- \usepackage[justification=raggedright,labelfont=bf,singlelinecheck=false]{caption}
# pour texte couleur http://ftp.cc.uoc.gr/mirrors/CTAN/macros/latex/contrib/xcolor/xcolor.pdf
- \usepackage{xcolor}
- \usepackage{titling}
- \pretitle{\begin{center}
  \includegraphics[width=6.5 in,height=20in]{bannière-facebook_ltips.jpeg}\LARGE\\}
- \posttitle{\end{center}}
---

```{r setup, include=FALSE}
# "https://intervals.icu/api/athlete/i1867070/activities.csv"
# nom athlète
athlete <- "Jules Cusson-Fradet"
# data
metriques_csv <- "1867070_activities.csv"
records_csv <- "athlete_1867070_power_curves.csv"
# selection période
selection_debut <- "2020-01-01"
selection_fin <- "2020-11-30" 
# déoucpage période
intervalle <- "1 month"

# nom pour YAML
nom_yaml <- paste0(athlete)

knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.align = "center",
  fig.pos = "h !"
)

options(knitr.table.format = "latex")

# packages 
library(tidyverse)
library(gridExtra)
library(googlesheets4)
library(forcats)
library(knitr)
library(kableExtra)
library(plotly)
library(webshot)
library(forcats)
library(RCurl)
library(httr)
require(downloader)
library(lubridate)
library(zoo)
library(roll)
library(TTR)
```

---
author: `r nom_yaml`
---

\vspace{12pt}
\vspace{12pt}
\vspace{12pt}
\vspace{12pt}
\vspace{12pt}
\vspace{12pt}
\vspace{12pt}
\vspace{12pt}
\vspace{12pt}
\vspace{12pt}
\vspace{12pt}
\vspace{12pt}
\vspace{12pt}
\vspace{12pt}

\center Analyse et production \center
\center __Jules Cusson-Fradet__, M.Sc. \center
\center Candidat au doctorat \center
\center Laboratoire de technologies & d’innovation pour la performance sportive (L-tips) \center

```{r cleaning}
metriques <- read_csv(metriques_csv)
records <- read_csv(records_csv)

# vars à additioner si plus de 1 entraînement/jour
vars_sum <-
   as.character(
      expression(
         moving_time,
         distance,
         elapsed_time,
         total_elevation_gain,
         calories,
         icu_joules,
         icu_training_load,
         hr_z1_secs,
         hr_z2_secs,
         hr_z3_secs,
         hr_z4_secs,
         hr_z5_secs,
         hr_z6_secs,
         hr_z7_secs,
         z1_secs,
         z2_secs,
         z3_secs,
         z4_secs,
         z5_secs,
         z6_secs,
         z7_secs
      )
   )

# vars à prendre le max si plusieurs entraînements/jour
vars_max <-
   as.character(
      expression(
         max_speed,
         max_heartrate,
         icu_eftp,
         icu_pm_ftp,
         icu_pm_cp,
         icu_pm_w_prime,
         icu_pm_p_max,
         icu_hrrc
      )
   )

# vars à prendre le avg si plusieurs entraînements/jour
vars_avg <-
   as.character(
      expression(
         average_speed,
         average_heartrate,
         average_cadence,
         icu_average_watts,
         icu_normalized_watts,
         icu_intensity,
         icu_variability,
         icu_efficiency
      )
   )

# calculer metriques par jour si plusieurs entraînements
metriques_sum <- metriques %>%
   # dttm en date
   mutate(start_date = date(start_date)) %>%
   group_by(start_date) %>%
   summarise_at(vars(vars_sum), sum, na.rm = FALSE)

metriques_max <- metriques %>%
   # dttm en date
   mutate(start_date = date(start_date)) %>%
   group_by(start_date) %>%
   summarise_at(vars(vars_max), max, na.rm = FALSE)

metriques_avg <- metriques %>%
   # dttm en date
   mutate(start_date = date(start_date)) %>%
   group_by(start_date) %>%
   summarise_at(vars(vars_avg), mean, na.rm = FALSE)

# joindre en un seul df
df_1 <- merge(metriques_sum, metriques_max, all = TRUE)
metriques_clean <- merge(df_1, metriques_avg, all = TRUE) %>%
   # selection période
   filter(between(start_date, as.Date(selection_debut), as.Date(selection_fin))) 
 
# déoucpage période
datebreaks <- seq(as.Date(selection_debut), as.Date(selection_fin), by = intervalle)

records_clean <- records %>% 
   janitor::clean_names() 
```

```{r TL, fig.width=11, fig.height=12.5}
charge_tss_ewma <- metriques_clean %>%
   select(start_date, icu_training_load) %>%
   mutate_at(vars(icu_training_load), ~ replace(., is.na(.), 0)) %>%
   mutate(
      aigue_7_tss = EMA(icu_training_load, n = 1, ratio = 2 / (1 + 7)),
      chronique_42_tss = EMA(icu_training_load, n = 1, ratio = 2 / (1 + 42)),
      fraicheur_tss = (chronique_42_tss - aigue_7_tss) / 100,
      ACWR_tss = aigue_7_tss / chronique_42_tss
   ) 

charge_kj_ewma <- metriques_clean %>%
   # diviser KJ par 100k pour nb plus lisible et conconrdance échelles graphs
   mutate(icu_joules_divised = icu_joules / 10000) %>%
   select(start_date, icu_joules_divised) %>%
   mutate_at(vars(icu_joules_divised), ~ replace(., is.na(.), 0)) %>%
   mutate(
      aigue_7_kj = EMA(icu_joules_divised, n = 1, ratio = 2 / (1 + 7)),
      chronique_42_kj = EMA(icu_joules_divised, n = 1, ratio = 2 / (1 + 42)),
      fraicheur_kj = (chronique_42_kj - aigue_7_kj) / 100,
      aigue_7_kj_sd = roll_sd(icu_joules_divised, 7, min_obs = 1),
      monotonie_kj = aigue_7_kj / aigue_7_kj_sd,
      ACWR_kj = aigue_7_kj / chronique_42_kj
   ) %>% 
   mutate_if(is.numeric, function(x) ifelse(is.infinite(x), 0, x))

charge_lutrimp_ewma <- metriques_clean %>%
   group_by(start_date) %>%
   # luTRIMP 3 zones model
   mutate(
      lutrimp_zone1 = (hr_z1_secs + hr_z2_secs * 1),
      lutrimp_zone2 = (hr_z3_secs + hr_z4_secs * 2),
      lutrimp_zone3 = (hr_z5_secs + hr_z6_secs + hr_z7_secs * 3),
      lutrimp = lutrimp_zone1 + lutrimp_zone2 + lutrimp_zone3
   ) %>%
   ungroup() %>%
   mutate(lutrimp = lutrimp / 100) %>%
   select(start_date, lutrimp) %>%
   mutate_at(vars(lutrimp), ~ replace(., is.na(.), 0)) %>%
   mutate(
      aigue_7_lutrimp = EMA(lutrimp, n = 1, ratio = 2 / (1 + 7)),
      chronique_42_lutrimp = EMA(lutrimp, n = 1, ratio = 2 / (1 + 42)),
      ACWR_lutrimp = aigue_7_lutrimp / chronique_42_lutrimp
   )

gg_tss <-
   ggplot(charge_tss_ewma, aes(start_date, weight = icu_training_load)) +
   geom_vline(
      xintercept = datebreaks,
      color = "#999999",
      size = 0.25,
      linetype = "dashed"
   ) +
   geom_bar(aes(fill = "")) +
   geom_area(aes(y = aigue_7_tss), fill = "#FF8247", alpha = 0.85) +
   geom_line(aes(y = aigue_7_tss, group = 1, color = "Aigue (7 jours)"), size =
                1.25) +
   geom_area(aes(y = chronique_42_tss), fill = "#1E90FF", alpha = 0.5) +
   geom_line(aes(y = chronique_42_tss, group = 1, color = "Chronique (42 jours)"),
             size = 1.25) +
   scale_color_manual(
      name = "",
      values = c("Aigue (7 jours)" = "#FF8247",
                 "Chronique (42 jours)" = "#1E90FF"),
      drop = FALSE
   ) +
   scale_fill_manual(name = "",
                    values = alpha("grey", .3),
                    labels = "Données journalières",
                    drop = FALSE) +
   labs(y = "TSS", x = "") +
   ggtitle("Charge (training stress score)") +
   theme_minimal() +
   theme(
      legend.position = "top",
      legend.title = element_blank(),
      axis.ticks.y = element_blank(),
      axis.title.x = element_blank(),
      axis.text.x = element_blank(),
      axis.title.y = element_text(colour = "#A6A6A6"),
      axis.text.y = element_text(colour = "#A6A6A6"),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(), 
      legend.margin = margin(t = 0, unit = 'cm')
   ) +
   guides(color = guide_legend(order = 1),
          fill = guide_legend(order = 2))

gg_kj <-
   ggplot(charge_kj_ewma, aes(start_date, weight = icu_joules_divised)) +
   geom_vline(
      xintercept = datebreaks,
      color = "#999999",
      size = 0.25,
      linetype = "dashed"
   ) +
   geom_bar(aes(fill = "")) +
   geom_area(aes(y = aigue_7_kj), fill = "#FF8247", alpha = 0.85) +
   geom_line(aes(y = aigue_7_kj, group = 1, color = "Aigue (7 jours)"), size =
                1.25) +
   geom_area(aes(y = chronique_42_kj), fill = "#1E90FF", alpha = 0.5) +
   geom_line(aes(y = chronique_42_kj, group = 1, color = "Chronique (42 jours)"),
             size = 1.25) +
   scale_color_manual(
      name = "",
      values = c("Aigue (7 jours)" = "#FF8247",
                 "Chronique (42 jours)" = "#1E90FF"),
      drop = FALSE
   ) +
   scale_fill_manual(name = "",
                    values = alpha("grey", .3),
                    labels = "Données journalières",
                    drop = FALSE) +
   labs(y = "KJ", x = "") +
   ggtitle("Charge travail simplifiée (kilojoule)") +
   theme_minimal() +
   theme(
      legend.position = "top",
      legend.title = element_blank(),
      axis.ticks.y = element_blank(),
      axis.title.x = element_blank(),
      axis.text.x = element_blank(),
      axis.title.y = element_text(colour = "#A6A6A6"),
      axis.text.y = element_text(colour = "#A6A6A6"),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(), 
      legend.margin = margin(t = 0, unit = 'cm')
   ) +
   guides(color = guide_legend(order = 1),
          fill = guide_legend(order = 2))

gg_trimp <-
   ggplot(charge_lutrimp_ewma, aes(start_date, weight = lutrimp)) +
   geom_vline(
      xintercept = datebreaks,
      color = "#999999",
      size = 0.25,
      linetype = "dashed"
   ) +
   geom_bar(aes(fill = "")) +
   geom_area(aes(y = aigue_7_lutrimp), fill = "#FF8247", alpha = 0.85) +
   geom_line(aes(y = aigue_7_lutrimp, group = 1, color = "Aigue (7 jours)"), size =
                1.25) +
   geom_area(aes(y = chronique_42_lutrimp),
             fill = "#1E90FF",
             alpha = 0.5) +
   geom_line(aes(y = chronique_42_lutrimp, group = 1, color = "Chronique (42 jours)"),
             size = 1.25) +
   scale_color_manual(
      name = "",
      values = c("Aigue (7 jours)" = "#FF8247",
                 "Chronique (42 jours)" = "#1E90FF"),
      drop = FALSE
   ) +
   scale_fill_manual(name = "",
                    values = alpha("grey", .3),
                    labels = "Données journalières",
                    drop = FALSE) +
   labs(y = "luTrimp", x = "") +
   scale_x_date(breaks = datebreaks, date_labels = "%b") +
   ggtitle("Charge luTrimp simplifiée (fréquence cardiaque)") +
   theme_minimal() +
   theme(
      legend.position = "top",
      legend.title = element_blank(),
      axis.ticks.y = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_text(colour = "#A6A6A6"),
      axis.text.x = element_text(colour = "#A6A6A6"),
      axis.text.y = element_text(colour = "#A6A6A6"),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(),
      legend.margin = margin(t = 0, unit = 'cm')
   ) +
   guides(color = guide_legend(order = 1),
          fill = guide_legend(order = 2))

gg_acwr_kj <-
   ggplot(charge_kj_ewma, aes(x = start_date, y = ACWR_kj, fill = ACWR_kj)) +
   geom_vline(
      xintercept = datebreaks,
      color = "#999999",
      size = 0.25,
      linetype = "dashed"
   ) +
   geom_bar(stat = "identity", aes(fill = cut(ACWR_kj, c(
      -Inf, 0.8, 1.3, 1.5, Inf
   )))) +
   scale_fill_manual(
      name = "",
      values = c(
         "(-Inf,0.8]" = "grey",
         "(0.8,1.3]" = "#00FA9A",
         "(1.3,1.5]" = "#EEB422",
         "(1.5, Inf]" = "#FF6A6A"
      ),
      labels = c(
         "Faible charge, risque quelquonce",
         "Charge optimale",
         "Risque moyen",
         "Risque élevé"
      ),
      drop = FALSE
   ) +
   labs(y = "ACWR", x = "") +
   ggtitle("Risque de maladaptation (aigue/chronique)") +
   theme_minimal() +
   #match order risque blessure
   guides(fill = guide_legend(reverse = TRUE)) +
   theme(
      legend.position = "top",
      legend.title = element_blank(),
      axis.ticks.y = element_blank(),
      axis.title.x = element_blank(),
      axis.text.x = element_blank(),
      axis.title.y = element_text(colour = "#A6A6A6"),
      axis.text.y = element_text(colour = "#A6A6A6"),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(), 
      legend.margin = margin(t = 0, unit = 'cm')
   )

gg_fra_kj <-
   ggplot(charge_kj_ewma,
          aes(x = start_date, y = fraicheur_kj, fill = fraicheur_kj)) +
   geom_vline(
      xintercept = datebreaks,
      color = "#999999",
      size = 0.25,
      linetype = "dashed"
   ) +
   geom_bar(stat = "identity", aes(fill = cut(fraicheur_kj, c(
      -Inf,-0.5, 0, 0.9, Inf
   )))) +
   scale_fill_manual(
      name = "",
      values = c(
         "(-Inf,-0.5]" = "#FF6A6A",
         "(-0.5,0]" = "#EEB422",
         "(0,0.9]" = "#00FA9A",
         "(0.9, Inf]" = "grey"
      ),
      labels = c(
         "Très haute charge aigue, faible fraîcheur",
         "Haute charge aigue",
         "Prêt à performer",
         "Faible charge, récupération"
      ),
      drop = FALSE
   ) +
   labs(y = "TSB", x = "") +
   ggtitle("Fraîcheur") +
   theme_minimal() +
   theme(
     legend.position = "top",
      legend.title = element_blank(),
      axis.ticks.y = element_blank(),
      axis.title.x = element_blank(),
      axis.text.x = element_blank(),
      axis.title.y = element_text(colour = "#A6A6A6"),
      axis.text.y = element_text(colour = "#A6A6A6"),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(), 
      legend.margin = margin(t = 0, unit = 'cm')
   )

gg_mono_kj <-
   ggplot(charge_kj_ewma,
          aes(x = start_date, y = monotonie_kj, fill = monotonie_kj)) +
   geom_vline(
      xintercept = datebreaks,
      color = "#999999",
      size = 0.25,
      linetype = "dashed"
   ) +
   geom_bar(stat = "identity", aes(fill = cut(monotonie_kj, c(0, 1.5, 2, Inf)))) +
   scale_fill_manual(
      name = "",
      values = c(
         "(0,1.5]" = "#00FA9A",
         "(1.5,2]" = "#EEB422",
         "(2,Inf]" = "#FF6A6A"
      ),
      labels = c(
         "Entraînement variable (faible monotonie)",
         "Entraînement ok",
         "Entraînement très répétitif (monotonie élevée)"
      ),
      drop = FALSE
   ) +
   labs(y = "Monotonie", x = "") +
   scale_x_date(breaks = datebreaks, date_labels = "%b") +
   ggtitle("Monotonie (variabilité charge 7 jours)") +
   theme_minimal() +
   #match order risque blessure
   guides(fill = guide_legend(reverse = TRUE)) +
   theme(
      legend.position = "top",
      legend.title = element_blank(),
      axis.ticks.y = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_text(colour = "#A6A6A6"),
      axis.text.x = element_text(colour = "#A6A6A6"),
      axis.text.y = element_text(colour = "#A6A6A6"),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(),
      legend.margin = margin(t = 0, unit = 'cm')
   )

graphs <- grid.arrange(
   arrangeGrob(gg_tss, ncol = 1, nrow = 1),
   arrangeGrob(gg_kj, ncol = 1, nrow = 1),
   arrangeGrob(gg_trimp, ncol = 1, nrow = 1),  
   heights = c(3.3, 3.3, 3.3)
)
```

\pagenumbering{arabic}

\newpage

```{r global,  fig.width=11, fig.height=12.5}
graphs <- grid.arrange(
   arrangeGrob(gg_kj, ncol = 1, nrow = 1),
   arrangeGrob(gg_acwr_kj, ncol = 1, nrow = 1),
   arrangeGrob(gg_fra_kj, ncol = 1, nrow = 1),
   arrangeGrob(gg_mono_kj, ncol = 1, nrow = 1),
   heights = c(2.5, 2.5, 2.5, 2.5)
)
```

```{r kjluTRIMP}
df_kj_lutrimp <-
   merge(charge_kj_ewma, charge_lutrimp_ewma, all = TRUE) %>%
   mutate(
      ACWR_kj_ravg = rollapply(
         ACWR_kj,
         7,
         mean,
         na.rm = TRUE,
         fill = NA,
         align = 'right',
         partial = TRUE
      ),
      ACWR_lutrimp_ravg = rollapply(
         ACWR_lutrimp,
         7,
         mean,
         na.rm = TRUE,
         fill = NA,
         align = 'right',
         partial = TRUE
      ),
   )

gg_kj_lutrimp <- df_kj_lutrimp %>%
   ggplot(aes(x = start_date)) +
   geom_vline(
      xintercept = datebreaks,
      color = "#999999",
      size = 0.25,
      linetype = "dashed"
   ) +
   annotate(
      "rect",
      ymin = 0.8,
      ymax = 1.3,
      xmin = min(df_kj_lutrimp$start_date),
      xmax = max(df_kj_lutrimp$start_date),
      fill = "#DCDCDC",
      alpha = 50 / 100
   ) +
   geom_line(
      aes(y = ACWR_kj_ravg,
          color = "ACWR Charge externe (W kJ)"),
      size = 1.25
   ) +
   geom_line(
      aes(y = ACWR_lutrimp_ravg,
          color = "ACWR Charge interne (FC LuTRIMP)"),
      size = 1.25
   ) +
   labs(x = "", y = "") +
   scale_x_date(breaks = datebreaks, date_labels = "%b") +
   scale_color_manual(
      name = "",
      values = alpha(c("#6633CC",
                 "#DD0347"), .6),
      drop = FALSE
   ) +
   theme_minimal() +
   theme(
      legend.position = "top",
      legend.title = element_blank(),
      axis.ticks.y = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_text(colour = "#A6A6A6"),
      axis.text.x = element_text(colour = "#A6A6A6"),
      axis.text.y = element_text(colour = "#A6A6A6"),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(),
      legend.margin = margin(t = 0, unit = 'cm')
   )

gg_kj_lutrimp
```

```{r heures}
gg_heures <- metriques_clean %>% 
   select(start_date, moving_time) %>%
   mutate(temps_h = round(moving_time / 3600, digits = 1)) %>% 
   group_by(mois = cut(start_date, "month")) %>%
   summarise_at(vars(temps_h),  sum, na.rm = TRUE) %>%
   mutate(mois = as.Date(mois, format = "%Y-%m-%d")) %>% 
   ggplot(aes(y = temps_h, x = mois)) +
   geom_bar(fill = "#00BFFF",
            alpha = 0.6,
            stat = "identity") +
   geom_text(aes(label=temps_h), vjust=1.6, color="black", size=3.5)+
   scale_x_date(breaks = datebreaks, date_labels = "%b") +
   labs(y = "Heures", x = "") +
   ggtitle("Heures d'entraînement") +
   theme_minimal() +
   theme(
      legend.position = "top",
      legend.title = element_blank(),
      axis.ticks = element_line(colour = "#A6A6A6"),
      axis.ticks.y = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_text(colour = "#A6A6A6"),
      axis.text.x = element_text(colour = "#A6A6A6"),
      axis.text.y = element_text(colour = "#A6A6A6"),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank()
   )

gg_heures
```

```{r TIDdurée}
tid <- metriques_clean %>%
   group_by(start_date) %>%
   # luTRIMP 3 zones model
   mutate(
      zone1 = (z1_secs + z2_secs),
      zone2 = (z3_secs + z4_secs),
      zone3 = (z5_secs + z6_secs + z7_secs))

gg_tid <- tid %>% 
   select(start_date, zone1, zone2, zone3) %>%
   group_by(mois = cut(start_date, "month")) %>%
   summarise_at(vars(zone1, zone2, zone3),  sum, na.rm = TRUE) %>%
   pivot_longer(
      cols = c(zone1, zone2, zone3),
      names_to = "zones",
      values_to = "secs"
   ) %>%
   mutate(mois = as.Date(mois, format = "%Y-%m-%d"),
          heures = secs / 3600) %>% 
   ggplot(aes(y = heures, x = mois)) +
   geom_bar(aes(fill = zones),
            alpha = 0.6,
            position = "dodge",
            stat = "identity") +
   scale_fill_manual(values = c("#00FA9A", "#EEB422", "#FF6A6A")) +
   labs(y = "Heures", x = "") +
   scale_x_date(breaks = datebreaks, date_labels = "%b") +
   ggtitle("Distribution de l'intensité (h)") +
   theme_minimal() +
   theme(
      legend.position = "top",
      legend.title = element_blank(),
      axis.ticks = element_line(colour = "#A6A6A6"),
      axis.ticks.y = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_text(colour = "#A6A6A6"),
      axis.text.x = element_text(colour = "#A6A6A6"),
      axis.text.y = element_text(colour = "#A6A6A6"),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(),
      legend.margin = margin(t = 0, unit = 'cm'
      )
   )

gg_tid
```

```{r TID}
gg_tid <- tid %>% 
   select(start_date, zone1, zone2, zone3) %>%
   group_by(mois = cut(start_date, "month")) %>%
   summarise_at(vars(zone1, zone2, zone3),  sum, na.rm = TRUE) %>%
   mutate(
      zone1_pct = (zone1 / (zone1 + zone2 + zone3) * 100),
      zone2_pct = (zone2 / (zone1 + zone2 + zone3) * 100),
      zone3_pct = (zone3 / (zone1 + zone2 + zone3) * 100)
   ) %>% 
   pivot_longer(
      cols = c(zone1_pct, zone2_pct, zone3_pct),
      names_to = "zones",
      values_to = "pourcentage"
   ) %>%
   mutate(mois = as.Date(mois, format = "%Y-%m-%d"),
          zones = recode_factor(zones,
                 zone1_pct = "zone1 %",
                 zone2_pct = "zone2 %",
                 zone3_pct = "zone3 %")) %>% 
   ggplot(aes(y = pourcentage, x = mois)) +
   geom_bar(aes(fill = fct_rev(zones)),
            alpha = 0.6,
            position = "stack",
            stat = "identity") +
   scale_fill_manual(values = c("#FF6A6A", "#EEB422", "#00FA9A")) +
   geom_text(aes(x = mois, label = paste0(round(pourcentage),'%')),
            colour = 'black', position=position_stack(vjust=0.5)) +
   labs(y = "%", x = "") +
   scale_x_date(breaks = datebreaks, date_labels = "%b") +
    scale_y_continuous(breaks = seq(from = 0, to = 100, by = 20)) +
   coord_cartesian(ylim=c(min(0), max(100)), expand = TRUE,
                  default = TRUE) +
   ggtitle("Distribution de l'intensité (%)") +
   theme_minimal() +
   theme(
     legend.position = "top",
      legend.title = element_blank(),
      axis.ticks = element_line(colour = "#A6A6A6"),
      axis.ticks.y = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_text(colour = "#A6A6A6"),
      axis.text.x = element_text(colour = "#A6A6A6"),
      axis.text.y = element_text(colour = "#A6A6A6"),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(),
      legend.margin = margin(t = 0, unit = 'cm'
      )
   )

gg_tid
```

```{r W/FC}
aero_fitness <- metriques_clean %>%
   mutate(
      icu_efficiency_ravg7 = rollapply(
         icu_efficiency,
         7,
         mean,
         na.rm = TRUE,
         fill = NA,
         align = 'right',
         partial = TRUE
      ),
      icu_efficiency_ravg60 = rollapply(
         icu_efficiency,
         60,
         mean,
         na.rm = TRUE,
         fill = NA,
         align = 'right',
         partial = TRUE
      ),
      icu_efficiency_norm = 0.75 * (roll_sd(icu_efficiency, 60, min_obs = 1)),
   ) %>%
   # remplacer NA par dernière valeur
   na.locf(na.rm = FALSE)  

 gg_aero <- ggplot(aero_fitness, aes(start_date, weight = icu_efficiency)) +
   geom_vline(
      xintercept = datebreaks,
      color = "#999999",
      size = 0.25,
      linetype = "dashed"
   ) +
   geom_ribbon(aes(
      ymin = (icu_efficiency_ravg60 - icu_efficiency_norm),
      ymax = (icu_efficiency_ravg60 + icu_efficiency_norm),
      fill = "Variabilité normale (60 jours)"
   )) +
   scale_fill_manual(
      name = "",
      values = alpha("#FF6A6A", .3),
      labels = "Variabilité normale (60 jours)",
      drop = FALSE
   ) +
   geom_line(aes(y = icu_efficiency_ravg7, color = "Tendance (7 jours)"), lwd = 1.5) +
   scale_color_manual(
      name = "",
      values = alpha("#DD0347", .6),
      labels = "Tendance (7 jours)",
      drop = FALSE
   ) +
   scale_x_date(breaks = datebreaks, date_labels = "%b") +
   labs(x = "", y = "(NP/FC)") +
   theme_minimal() +
   ggtitle("Efficacité aérobique") +
   theme(
      legend.position = "top",
      legend.title = element_blank(),
      axis.ticks.y = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_text(colour = "#A6A6A6"),
      axis.text.x = element_text(colour = "#A6A6A6"),
      axis.text.y = element_text(colour = "#A6A6A6"),
      legend.margin = margin(t = 0, unit = 'cm')
   ) +
   guides(color = guide_legend(order = 1),
          fill = guide_legend(order = 2))

gg_aero
```

```{r hrrc}
hrrc <- metriques_clean %>%
   mutate(
      icu_hrrc_ravg7 = rollapply(
         icu_hrrc,
         7,
         mean,
         na.rm = TRUE,
         fill = NA,
         align = 'right',
         partial = TRUE
      ),
      icu_hrrc_ravg60 = rollapply(
         icu_hrrc,
         60,
         mean,
         na.rm = TRUE,
         fill = NA,
         align = 'right',
         partial = TRUE
      ),
      icu_hrrc_norm = 0.75 * (roll_sd(icu_hrrc, 60, min_obs = 1)),
   ) %>%
   # remplacer NA par dernière valeur
   na.locf(na.rm = FALSE)  

gg_hrrc <- ggplot(hrrc, aes(start_date, weight = icu_hrrc)) +
   geom_vline(
      xintercept = datebreaks,
      color = "#999999",
      size = 0.25,
      linetype = "dashed"
   ) +
   geom_ribbon(aes(
      ymin = (icu_hrrc_ravg60 - icu_hrrc_norm),
      ymax = (icu_hrrc_ravg60 + icu_hrrc_norm),
      fill = "Variabilité normale (60 jours)"
   )) +
   scale_fill_manual(
      name = "",
      values = alpha("#DA70D6", .3),
      labels = "Variabilité normale (60 jours)",
      drop = FALSE
   ) +
   geom_line(aes(y = icu_hrrc_ravg7, color = "Tendance (7 jours)"), lwd = 1.5) +
   scale_color_manual(
      name = "",
      values = alpha("#DA70D6", .6),
      labels = "Tendance (7 jours)",
      drop = FALSE
   ) +
   scale_x_date(breaks = datebreaks, date_labels = "%b") +
   labs(x = "", y = "HRR") +
   theme_minimal() +
   ggtitle("Récupération cardiaque") +
   theme(
      legend.position = "top",
      legend.title = element_blank(),
      axis.ticks.y = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_text(colour = "#A6A6A6"),
      axis.text.x = element_text(colour = "#A6A6A6"),
      axis.text.y = element_text(colour = "#A6A6A6"),
      legend.margin = margin(t = 0, unit = 'cm')
   ) +
   guides(color = guide_legend(order = 1),
          fill = guide_legend(order = 2))

gg_hrrc
```


```{r eFTP}
eftp <- metriques_clean %>%
   mutate(
      icu_eftp_ravg7 = rollapply(
         icu_eftp,
         7,
         mean,
         na.rm = TRUE,
         fill = NA,
         align = 'right',
         partial = TRUE
      ),
      icu_eftp_ravg60 = rollapply(
         icu_eftp,
         60,
         mean,
         na.rm = TRUE,
         fill = NA,
         align = 'right',
         partial = TRUE
      ),
      icu_eftp_norm = 0.75 * (roll_sd(icu_eftp, 60, min_obs = 1)),
   ) %>%
   mutate_if(is.numeric, ~ replace(., is.na(.), 0))

gg_eftp <- ggplot(eftp, aes(start_date, weight = icu_eftp)) +
   geom_vline(
      xintercept = datebreaks,
      color = "#999999",
      size = 0.25,
      linetype = "dashed"
   ) +
   geom_ribbon(aes(
      ymin = (icu_eftp_ravg60 - icu_eftp_norm),
      ymax = (icu_eftp_ravg60 + icu_eftp_norm),
      fill = "Variabilité normale (60 jours)"
   )) +
   scale_fill_manual(
      name = "",
      values = alpha("#6633CC", .3),
      labels = "Variabilité normale (60 jours)",
      drop = FALSE
   ) +
   geom_line(aes(y = icu_eftp_ravg7, color = "Tendance (7 jours)"), lwd = 1.5) +
   scale_color_manual(
      name = "",
      values = alpha("#6633CC", .6),
      labels = "Tendance (7 jours)",
      drop = FALSE
   ) +
   scale_x_date(breaks = datebreaks, date_labels = "%b") +
   labs(x = "", y = "W") +
   theme_minimal() +
   ggtitle("Modélisation FTP") +
   theme(
      legend.position = "top",
      legend.title = element_blank(),
      axis.ticks.y = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_text(colour = "#A6A6A6"),
      axis.text.x = element_text(colour = "#A6A6A6"),
      axis.text.y = element_text(colour = "#A6A6A6"),
      legend.margin = margin(t = 0, unit = 'cm')
   ) +
   guides(color = guide_legend(order = 1),
          fill = guide_legend(order = 2))

gg_eftp
```

```{r kjkm}


```

```{r tableauRES}
# voir tab leo

```

```{r MMP}
# y axis 0 to max power by 100
gg_mmp <- records_clean %>%
   filter(secs <= 1200) %>%
   pivot_longer(
      cols = c(this_season:this_season_3000k_j),
      names_to = "records",
      values_to = "watts"
   ) %>%
   ggplot(aes(x = secs, y = watts, colour = records)) +
   geom_line(lwd = 1.5, alpha = 0.6) +
   scale_x_log10(
      breaks = c(1, 5, 15, 30, 60, 120, 300, 720, 1200),
      labels = c("1s", "5s", "15s", "30s", "1m", "2m", "5m", "12m", "20m")
   ) +
   labs(y = "Puissance  (watts)\n",
        x = "\nTemps",
        color = "") +
   theme_minimal() +
   theme(
      axis.text.x = element_text(colour = "#A6A6A6"),
      axis.text.y = element_text(colour = "#A6A6A6"),
      axis.title.x = element_text(colour = "#A6A6A6"),
      axis.title.y = element_text(colour = "#A6A6A6"),
      panel.grid.minor.y = element_blank(),
      panel.grid.minor.x = element_blank(),
      legend.position = "top"
   )

gg_mmp
```

```{r tableauMMP}

```

